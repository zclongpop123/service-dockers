version: '3'

services:
    
    portainer:
        container_name: Portainer
        
        image: portainer/portainer:latest
        restart: unless-stopped
        
        networks:
            extnetwork:
                ipv4_address: 172.20.0.2

        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
            - /home/portainer:/data

        #ports:
        #    - '9000:9000'


    
    
    postgres96:
        container_name: Postgres96

        image: postgres:9.6
        restart: unless-stopped

        networks:
            extnetwork:
                ipv4_address: 172.20.0.3

        volumes:
            - /home/postgresql/data:/var/lib/postgresql/data

        environment:
            POSTGRES_PASSWORD: password

        ports:
            - '5432:5432'
    
    
    
    mongo:
        container_name: MongoDB
                
        image: mongo:latest
        restart: unless-stopped

        networks:
            extnetwork:
                ipv4_address: 172.20.0.4
        
        environment:
            MONGO_INITDB_ROOT_USERNAME: root
            MONGO_INITDB_ROOT_PASSWORD: example

        volumes:
            - /home/mongo/db:/data/db
            - /home/mongo/configdb:/data/configdb

        ports:
            - '27017:27017'


    nginx:
        container_name: Nginx
        
        image: nginx:latest
        restart: unless-stopped
        
        networks:
            extnetwork:
                ipv4_address: 172.20.0.5
        
        volumes:
            - /home/nginx/conf.d:/etc/nginx/conf.d
        
        ports:
            - '80:80'
            - '443:443'



    jira:
        container_name: Jira_ServiceDesk
        user: '2001:2001'

        image: atlassian/jira-servicedesk
        restart: unless-stopped

        depends_on:
            - postgres96

        networks:
            extnetwork:
                ipv4_address: 172.20.0.6

        volumes:
            - /home/jira:/var/atlassian/application-data/jira

        environment:
            - JVM_MINIMUM_MEMORY=1024m
            - JVM_MAXIMUM_MEMORY=16384m

            - ATL_PROXY_NAME=jira.ds.com
            - ATL_PROXY_PORT=80

        #ports:
        #    - '8080:8080'



    confluence:
        container_name: Confluence
        user: '2002:2002'

        image: atlassian/confluence-server:latest
        restart: unless-stopped

        depends_on:
            - postgres96

        networks:
            extnetwork:
                ipv4_address: 172.20.0.7

        volumes:
            - /home/confluence:/var/atlassian/application-data/confluence

        environment:
            - JVM_MINIMUM_MEMORY=1024m
            - JVM_MAXIMUM_MEMORY=16384m
        
            - ATL_PROXY_NAME=wiki.ds.com
            - ATL_PROXY_PORT=80

        ports:
            - '8090:8090'
            - '8091:8091'



    gitlab:
        container_name: Gitlab

        image: gitlab/gitlab-ce:latest
        restart: unless-stopped

        networks:
            extnetwork:
                ipv4_address: 172.20.0.9

        volumes:
            - /home/gitlab/config:/etc/gitlab
            - /home/gitlab/log:/var/log/gitlab
            - /home/gitlab/data:/var/opt/gitlab

        ports:
            - '2022:22'
            #- '20080:80'
            #- '20443:443'


    rabbitmq:
        container_name: RabbitMQ
        
        image: rabbitmq:3.8.2-management
        restart: unless-stopped

        networks:
            extnetwork:
                ipv4_address: 172.20.0.10
        
        volumes:
            - /home/rabbitmq/data:/var/lib/rabbitmq

        environment:
            - RABBITMQ_DEFAULT_USER=admin
            - RABBITMQ_DEFAULT_PASS=password

        ports:
            - '5672:5672'
            - '15672:15672'

    
    netdata:
        container_name: NetData
        
        image: netdata/netdata
        restart: unless-stopped

        networks:
            extnetwork:
                ipv4_address: 172.20.0.11
        
        volumes:
            - /proc:/host/proc:ro
            - /sys:/host/sys:ro
            - /var/run/docker.sock:/var/run/docker.sock:ro
        
        cap_add:
            - SYS_PTRACE
        
        security_opt:
            - apparmor:unconfined

        #ports:
        #    - '19999:19999'


    mongo-express:
        container_name: MongoExpress

        image: mongo-express
        restart: unless-stopped

        networks:
            extnetwork:
                ipv4_address: 172.20.0.12

        environment:
            ME_CONFIG_MONGODB_SERVER: mongo
            ME_CONFIG_MONGODB_PORT: 27017
            ME_CONFIG_MONGODB_ADMINUSERNAME: root
            ME_CONFIG_MONGODB_ADMINPASSWORD: example

        #ports:
        #    - 8081:8081



    filebrowser:
        container_name: FileBrowser

        image: filebrowser/filebrowser
        restart: unless-stopped

        networks:
            extnetwork:
                ipv4_address: 172.20.0.13
        
        volumes:
            - /home/filebrowser/data:/data
            - /mnt:/srv

        #ports:
        #    - 80:80
        

    shotgun-event:
        container_name: ShotgunEvent

        image: shotgun-event
        restart: unless-stopped

        networks:
            extnetwork:
                ipv4_address: 172.20.0.14

        volumes:
            - /home/pipeline/shotgunEventDaemon:/home/pipeline/shotgunEventDaemon
            - /home/pipeline/shotgunEventDaemon/shotgunEvents/src/:/usr/src/myapp

        working_dir: /usr/src/myapp

        entrypoint: ["python", "shotgunEventDaemon.py", "foreground"]



    deadlinewebservice:
        container_name: DeadlineWebService

        image: deadline-client
        restart: unless-stopped

        networks:
            extnetwork:
                ipv4_address: 172.20.0.15

        volumes:
            - /opt/Thinkbox/DeadlineRepository10:/mnt/DeadlineRepository10

        ports:
            - 8082:8082

        entrypoint: ["./deadlinewebservice"]



    sg-memcached:
        container_name: Shotgun-Memcached

        image: memcached:1.4
        restart: unless-stopped

        networks:
            extnetwork:
                ipv4_address: 172.20.0.16


    sg-app:
        container_name: Shotgun-App

        image: shotgun-app:8.8.0.3275
        restart: unless-stopped

        environment:
            SHOTGUN_SITE_URL: test-shotgun.ds.com
            POSTGRES_HOST: postgres96
            POSTGRES_DB: shotgun_db
            POSTGRES_PORT: 5432
            POSTGRES_USER: shotgun_db_user
            POSTGRES_PASSWORD: zcl.123
            MEMCACHED_HOST: sg-memcached
            MEMCACHED_PORT: 11211

        labels:
            com.shotgunsoftware.component: app

        volumes:
            - /home/shotgun/media:/media
            - /home/shotgun/rb:/var/rails/shotgun/current/script/rb

        depends_on:
            - sg-memcached
            - postgres96

        logging:
            driver: "json-file"

            options:
                max-size: "2g"
                max-file: "20"
        
        ports:
            - "9000:80"

        networks:
            extnetwork:
                ipv4_address: 172.20.0.17
                aliases:
                    - test-shotgun.ds.com


    sg-dbops:
        image: postgres:9.6

        command: ["/bin/bash"]
        stdin_open: true
        tty: true

        depends_on:
            - postgres96

        environment:
            PGHOST: postgres96
            PGPORT: 5432
            PGUSER: shotgun_db_user
            PGDATABASE: shotgun_db
            PGOPTIONS: "-c statement_timeout=0"
            PGPASSWORD: zcl.123

        labels:
            com.shotgunsoftware.component: dbops

        volumes:
            - /home/shotgun/db_backup:/db_backup



    sg-transcoderserver:
        container_name: Shotgun-TranscoderServer
        
        image: shotgun-transcoder-server:6.4.0
        restart: unless-stopped

        depends_on:
            - postgres96

        environment:
            POSTGRES_HOST: postgres96
            POSTGRES_DB: shotgun_transcoding
            POSTGRES_PORT: 5432
            POSTGRES_USER: shotgun_db_user
            POSTGRES_PASSWORD: zcl.123
            DASHBOARD_USERNAME: admin
            DASHBOARD_PASSWORD: admin

        labels:
            com.shotgunsoftware.component: transcoderserver
        
        #ports:
        #    - "8008:80"

        networks:
            extnetwork:
                ipv4_address: 172.20.0.17



    sg-transcoderworker:
        container_name: Shotgun-TranscoderWorker
        
        image: shotgun-transcoder-worker:10.5.0
        restart: unless-stopped
        
        depends_on:
            - postgres96

        environment:
            #TRANSCODER_TRANSCODE_H264_VCODEC: -vcodec libx264 -pix_fmt yuv420p -vf 'scale=trunc((a*oh)/2)*2:1080' -g 30 -b:v 2000k -vprofile high -bf 0 -crf 26
            #TRANSCODER_TRANSCODE_WEBM_VCODEC: -vcodec libvpx -vf 'scale=trunc((a*oh)/2)*2:1080' -g 30 -b:v 2000k -speed 1 -quality realtime -cpu-used 0 -qmin 10 -qmax 42
            M_SCAN_ENABLED: 'false'
            POSTGRES_HOST: postgres96
            POSTGRES_DB: shotgun_transcoding
            POSTGRES_PORT: 5432
            POSTGRES_USER: shotgun_db_user
            POSTGRES_PASSWORD: zcl.123
        
        labels:
            com.shotgunsoftware.component: transcoderworker
        
        volumes:
            - /home/shotgun/media:/media            
            
        networks:
            extnetwork:
                ipv4_address: 172.20.0.18



networks:
    extnetwork:
        driver: bridge
        ipam:
            config:
                - subnet: 172.20.0.0/16
